---
title: 设计和控制会话流 | Microsoft Docs
description: 了解如何在机器人中设计和控制会话流，为用户提供出色体验。
keywords: 设计, 控制, 会话流, 句柄中断, 概述
author: v-ducvo
ms.author: v-ducvo
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 4/8/2018
ms.openlocfilehash: 09568fca31649880df0f5b4fbc47f50288e907cb
ms.sourcegitcommit: f576981342fb3361216675815714e24281e20ddf
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/18/2018
ms.locfileid: "39297711"
---
::: moniker range="azure-bot-service-3.0"

# <a name="design-and-control-conversation-flow"></a>设计和控制会话流

在传统应用程序中，用户界面 (UI) 是一系列屏幕。 
单个应用或网站可以根据需要使用一个或多个屏幕与用户交换信息。 
在大多数应用程序启动主屏幕中，用户可以进行初始登录，该屏幕还提供指向其他屏幕以使用各种功能（如启动新的订单、浏览产品，或寻求帮助）的导航。

与应用和网站类似，机器人具有 UI，但它由对话框组成，而不是屏幕。 
对话框可让机器人开发人员从逻辑上分隔机器人功能的各个区域并指引会话流。 例如，你可能会设计一个对话框，其中包含可帮助用户浏览产品的逻辑，以及一个单独的对话框，其中包含可帮助用户创建新订单的逻辑。 

对话框不一定具有图形界面。 它们可能包含按钮、文本和其他元素，或者完全基于语音。 对话框还包含要执行诸如调用其他对话框或处理用户输入的任务的操作。

## <a name="using-dialogs-to-manage-conversation-flow"></a>使用对话框管理会话流

[!INCLUDE [Dialog flow example](~/includes/snippet-dotnet-manage-conversation-flow-intro.md)]

有关使用对话框和 Bot Builder SDK 管理会话流的详细演练，请参阅：

- [使用对话框管理会话流 (.NET)](~/dotnet/bot-builder-dotnet-manage-conversation-flow.md)
- [使用对话框管理会话流 (Node.js)](~/nodejs/bot-builder-nodejs-manage-conversation-flow.md)

## <a name="dialog-stack"></a>对话框堆栈

一个对话框调用另一个对话框时，机器人生成器会将新对话框添加到对话框堆栈的顶部。 
位于堆栈顶部的对话框控制会话。 
用户发送的每条新消息均通过该对话框处理，直到对话框关闭或重定向到另一个对话框。 
对话框关闭后，它将从堆栈中删除，堆栈中的上一个对话框接管会话。 

> [!IMPORTANT]
> 请务必了解在对话框互相调用、关闭等操作时，机器人生成器如何构建和解构对话框堆栈的概念，这是高效设计机器人会话流的关键所在。 

## <a name="dialogs-stacks-and-humans"></a>对话框、堆栈和人类

假定用户将在对话框中导航、创建对话框堆栈，并且在某些时候将导航回到他们的源位置，以整齐有序的方式逐一取消堆叠对话框，这可能非常具有吸引力。 
例如，用户将从根对话框开始，从该位置调用新订单对话框，然后调用产品搜索对话框。 
然后用户将选择产品并确认，退出产品搜索对话框，完成订单，退出新订单对话框，并返回到根对话框。 

如果用户始终能够完成这样一个线性逻辑路径，那将是再好不过了，但很少能够实现。 
人类不会在“堆栈”中通信。 他们往往会频繁地改变主意。 
下面是一个示例： 

![机器人](~/media/bot-service-design-conversation-flow/stack-issue.png)

虽然机器人可能在逻辑上构建了一个对话框堆栈，但用户可能决定做一些完全不同的事情，或者询问可能与当前主题无关的问题。 
在该示例中，用户询问问题而不是提供对话框期望的是/否响应。 
对话框应如何响应？

- 坚持让用户先回答问题。 
- 忽略用户之前完成的所有操作，重置整个对话框堆栈，并从头开始尝试回答用户的问题。 
- 尝试回答用户的问题，然后返回到是/否问题并尝试从该位置继续。 

此问题没有正确答案，因为最佳解决方案将取决于你的具体应用场景，以及用户如何合理地期望机器人做出响应。 

## <a name="next-steps"></a>后续步骤

在对话框中管理用户的导航，并通过使用户能够实现其目标的方式（甚至是以非线性方式）设计会话流，这是机器人设计的一个基本挑战。 
[下一篇文章](~/bot-service-design-navigation.md)回顾了设计不良导航的一些常见缺陷，并讨论了避免这些问题的策略。 

::: moniker-end

::: moniker range="azure-bot-service-4.0"
# <a name="design-and-control-conversation-flow"></a>设计和控制会话流

在传统应用程序中，用户界面 (UI) 由一系列屏幕组成，单个应用或网站可以根据需要使用一个或多个屏幕与用户交换信息。 
在大多数应用程序启动主屏幕中，用户可以进行初始登录，该屏幕还提供指向其他屏幕以使用各种功能（如启动新的订单、浏览产品，或寻求帮助）的导航。

与应用和网站类似，机器人具有 UI，但它由消息组成，而不是屏幕。 消息可能包含按钮、文本和其他元素，或者完全基于语音。 

虽然传统应用程序或网站可以在屏幕上同时请求多条信息，但机器人将使用多条消息收集相同数量的信息。 通过这种方式，从用户处收集信息的过程成为一种积极的体验：用户可以与机器人进行活动会话。 

一个设计良好的机器人将拥有一个自然的会话流。 机器人应该能够无缝地处理核心会话，并且能够从容地处理中断或切换会话主题。 

## <a name="procedural-conversation-flow"></a>程序会话流

与机器人的会话通常集中在机器人试图实现的任务上，这称为程序流程。 这是机器人向用户询问一系列问题以收集在处理任务之前所需的所有信息的地方。

在程序会话流中，可以定义问题的顺序，机器人将按你定义的顺序提出问题。 可以将问题组织到逻辑模块中，保持代码的集中性，同时专注于引导会话。 例如，你可能会设计一个模块，其中包含可帮助用户浏览产品的逻辑，以及一个单独的模块，其中包含可帮助用户创建新订单的逻辑。 

可以按照自己喜欢的任何方式将这些模块构建到流程中，自由格式或顺序格式均可。 Bot Builder SDK 提供了多个库，使用这些库可以构造机器人所需的任何会话流。 例如，使用 `prompts` 库可以要求用户输入，使用 `waterfall` 库可以定义一系列问题/答案对，使用 `dialog control` 库可以模块化会话流逻辑，等等。所有这些库通过 `dialogs` 对象绑定在一起。 让我们进一步了解如何将模块实现为 `dialogs` 来设计和管理会话流，并查看该流是否类似于传统应用程序流。

![机器人](~/media/designing-bots/core/dialogs-screens.png)

在传统应用程序中，一切都从主屏幕开始。
主屏幕调用“新建订单”屏幕。
“新建订单”屏幕在关闭或调用其他屏幕（例如“产品搜索”屏幕）之前一直处于受控状态。 
如果“新建订单”屏幕关闭，用户将返回主屏幕。

在机器人中，一切都从根对话框开始。 
根对话框调用“新建订单”对话框。 
此时，“新建订单”对话框控制会话并保持控制状态，直到它关闭或调用其他对话框（例如“产品搜索”对话框）。 
如果“新建订单”对话框关闭，对话框的控制权会返回给根对话框。

请查看有关[会话流](v4sdk/bot-builder-conversations.md)的概念性主题，了解更多类型的会话。

## <a name="handle-interruptions"></a>处理中断

假设用户将以整齐有序的方式逐一执行程序任务，这可能非常具有吸引力。 
例如，在程序会话流中使用 `dialogs` 后，用户将从根对话框开始，从该位置调用新订单对话框，然后调用产品搜索对话框。 然后用户将选择产品并确认，退出产品搜索对话框，完成订单，退出新订单对话框，并返回到根对话框。 

如果用户始终能够完成这样一个线性逻辑路径，那将是再好不过了，但很少能够实现。 
人类不会按有序的 `dialogs` 通信。 他们往往会频繁地改变主意。 
下面是一个示例： 

![机器人](~/media/bot-service-design-conversation-flow/stack-issue.png)

虽然机器人可能以程序化为重点，但用户可能决定做一些完全不同的事情，或者询问可能与当前主题无关的问题。 
在上述示例中，用户询问问题而不是提供机器人期望的是/否响应。 
机器人应如何响应？

- 坚持让用户先回答问题。 
- 忽略用户之前完成的所有操作，重置整个对话框堆栈，并从头开始尝试回答用户的问题。 
- 尝试回答用户的问题，然后返回到是/否问题并尝试从该位置继续。 

此问题没有正确答案，因为最佳解决方案将取决于你的具体应用场景，以及用户如何合理地期望机器人做出响应。 有关详细信息，请参阅[处理用户中断](v4sdk/bot-builder-howto-handle-user-interrupt.md)。

## <a name="next-steps"></a>后续步骤

在对话框中管理用户的导航，并通过使用户能够实现其目标的方式（甚至是以非线性方式）设计会话流，这是机器人设计的一个基本挑战。 
[下一篇文章](~/bot-service-design-navigation.md)回顾了设计不良导航的一些常见缺陷，并讨论了避免这些问题的策略。 

::: moniker-end
