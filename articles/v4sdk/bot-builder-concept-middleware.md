---
title: 中间件 | Microsoft Docs
description: 了解中间件及其在机器人 SDK 中的用法。
keywords: 中间件, 中间件管道, 短路, 中间件用法
author: ivorb
ms.author: v-ivorb
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.subservice: sdk
ms.date: 11/8/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 1bfa180967c55aac6012e02887ac2893947263f9
ms.sourcegitcommit: 91156d0866316eda8d68454a0c4cd74be5060144
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/07/2018
ms.locfileid: "53010582"
---
# <a name="middleware"></a>中间件

[!INCLUDE [pre-release-label](../includes/pre-release-label.md)]

中间件只是一个位于适配器和机器人逻辑之间的类，它是在初始化期间添加到适配器的中间件集合的。 SDK 可让用户自行编写中间件或添加其他人创建的中间件。 进出机器人的每个活动都流经中间件。

适配器处理传入的活动并通过机器人中间件管道将其定向到机器人的逻辑，然后再返回。 当每个活动流入和流出机器人时，每个中间件都可以在机器人逻辑运行前后对其进行检查或执行操作。

在深入了解中间件之前，请务必先了解[机器人概要](~/v4sdk/bot-builder-basics.md)和[机器人处理活动的方式](~/v4sdk/bot-builder-basics.md#the-activity-processing-stack)。

## <a name="uses-for-middleware"></a>中间件用法
经常会出现这样的问题：“什么时候我应该将操作作为中间件来实现，而不是使用普通机器人逻辑？” 中间件为你提供了额外的机会，在处理每个_轮次_的聊天前后与用户的聊天流进行交互。 中间件还允许你存储和检索有关聊天的信息，并在需要时调用其他处理逻辑。 下面是一些常见的场景，展示了中间件可能有用的地方。

### <a name="looking-at-or-acting-on-every-activity"></a>观察或操作每个活动
很多情况下，需要机器人对每个活动或某种类型的每个活动执行某些操作。 例如，你可能希望记录机器人收到的每个消息活动，或者在机器人本回合未生成响应时提供回退响应。 中间件便是实现这种操作的绝佳位置，它能够在执行剩余机器人逻辑的前后执行操作。

### <a name="modifying-or-enhancing-the-turn-context"></a>修改或增强回合上下文
如果机器人知道的信息比活动中提供的多，这会让某些聊天将更富成效。 在这种情况下，中间件可以查看截至目前的聊天状态信息、查询外部数据源，还可在将执行传递给机器人逻辑之前将其附加到[轮次上下文](~/v4sdk/bot-builder-basics.md#defining-a-turn)对象。 

SDK 定义了可记录传入和传出活动的日志记录中间件，但你也可以定义自己的中间件。

## <a name="the-bot-middleware-pipeline"></a>机器人中间件管道
对于每个活动，适配器都按照其添加顺序调用中间件。 适配器传入回合的上下文对象和下一个委托，而中间件会调用该委托，将控制权传递给管道中的下一个中间件。 在完成方法之前，中间件仍有机会在下一个委托返回后执行操作。 你可以将其视为每个中间件对象始终都有机会对管道中的下一个中间件对象执行操作。

例如：

- 第一个中间件对象的回合处理程序在调用下一个对象之前执行代码。
  - 第二个中间件对象的回合处理程序在调用下一个对象之前执行代码。
    - 机器人的回合处理程序执行操作并返回结果。
  - 第二个中间件对象的回合处理程序在返回之前执行代码的所有余下部分。
- 第一个中间件对象的回合处理程序在返回之前执行代码的所有余下部分。

如果中间件不调用下一个委托，则适配器不会调用任何后续中间件或机器人回合处理程序，并且管道出现短路。

机器人中间件管道完成后，回合结束，且回合上下文超出范围。

中间件或机器人可以生成响应并注册响应事件处理程序，但请记住，响应是在单独的进程中处理的。

## <a name="order-of-middleware"></a>中间件的顺序
由于添加中间件的顺序决定了中间件处理活动的顺序，因此有必要确定添加中间件的顺序。

> [!NOTE]
> 这意味着为你提供一种适用于大多数机器人的通用模式，但一定要根据自己的情况考虑每个中间件将如何与其他中间件进行交互。

处理每次使用的最低级别任务的中间件应该排在中间件管道中的最前面。 相关示例包括日志记录、异常处理和转换。 其排序顺序视需要而定，例如是要先转换传入的消息再存储消息，还是要先存储消息，后者可能意味着不会转换已存储的消息。

机器人特定的中间件应该排在中间件管道中的最后面，此类中间件可对发送到机器人的每个消息进行某些处理。 如果中间件使用状态信息或机器人上下文中设置的其他信息，请将其添加到中间件管道中用于修改状态或上下文的中间件的后面。

## <a name="short-circuiting"></a>短路
有关中间件和响应处理程序的一个重要概念是“短路”。 如果要通过后续的层继续执行，需使用中间件（或响应处理程序）调用该执行的_下一个_委托，将执行传递下去。  如果未在该中间件（或响应处理程序）中调用下一个委托，则关联的管道将发生短路并且不会执行后续层。 这意味着将跳过所有机器人逻辑以及管道中后面的所有中间件。 对于将一个轮次短路而言，中间件和响应处理程序之间存在细微差别。

当中间件将一个轮次短路时，将不会调用机器人轮次处理程序，但是在此之前在管道中执行的所有中间件代码仍然会运行到结束。 

对于事件处理程序，不调用下一个委托则会取消事件，这与中间件跳过逻辑得到的结果明显不同。 如果不处理事件的其余部分，则适配器永远不会发送该事件。

> [!TIP]
> 如果响应事件（如 `SendActivities`）短路，请确保这是意料中的行为。 否则，它可能会导致难以修复 bug。

## <a name="response-event-handlers"></a>响应事件处理程序
除了应用程序和中间件逻辑以外，还可将响应处理程序（有时也称为事件处理程序或活动事件处理程序）添加到上下文对象中。 在执行实际响应之前，当前上下文对象上出现相关响应时，将调用这些处理程序。 当知道要在实际事件之前或之后对其余当前响应的该类型的所有活动执行某些操作时，这些处理程序非常有用。

> [!WARNING]
> 注意，请勿从它的相应响应事件处理程序中调用活动响应方法，例如，从发送活动处理程序中调用发送活动方法。 执行此操作可以生成一个无限循环。

请记住，每个新活动都会获得一个要执行的新线程。 创建处理活动的线程后，该活动的处理程序列表将复制到该新线程。 不会针对该特定活动事件执行在此之后添加的任何处理程序。
在上下文对象中注册的处理程序的处理方式与适配器管理中间件管道的方式非常相似。 也就是说，处理程序按照它们添加的顺序进行调用，并且调用下一个委托将控制权传递给下一个已注册的事件处理程序。 如果处理程序未调用下一个委托，则不会调用任何后续事件处理程序，事件会短路，并且适配器不会将响应发送到通道。

## <a name="handling-state-in-middleware"></a>处理中间件中的状态

保存状态的一种常用方法是在轮次处理程序的末尾调用 save changes 方法。 以下示意图中突出显示了该调用。

![状态中间件问题](media/bot-builder-dialog-state-problem.png)

此方法的问题是，在机器人的轮次处理程序返回后，从某些自定义中间件进行状态更新时，更新不会保存到持久存储。 解决方法是通过将“自动保存更改”中间件的实例添加到中间件堆栈的开头，或至少添加到可能更新状态的任一中间件之前，在自定义中间件完成后，将调用转移到 save changes 方法。 执行情况如下所示。

![状态中间件解决方案](media/bot-builder-dialog-state-solution.png)

添加需要更新机器人状态集对象的状态管理对象，然后在创建“自动保存更改”中间件时使用这些对象。

## <a name="additional-resources"></a>其他资源
可以查看一下用 Bot Builder SDK [[C#](https://github.com/Microsoft/botbuilder-dotnet/blob/master/libraries/Microsoft.Bot.Builder/TranscriptLoggerMiddleware.cs) | [JS](https://github.com/Microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/transcriptLogger.ts)] 实现的脚本记录器中间件。
