---
title: 中间件 | Microsoft Docs
description: 了解中间件及其在机器人 SDK 中的用法。
keywords: 中间件, 中间件管道, 短路, 中间件用法
author: ivorb
ms.author: v-ivorb
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 05/24/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 9986ac7d46acfa94694456d653b91dd66c1f55f0
ms.sourcegitcommit: f95702d27abbd242c902eeb218d55a72df56ce56
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/19/2018
ms.locfileid: "39298561"
---
# <a name="middleware"></a>中间件

[!INCLUDE [pre-release-label](~/includes/pre-release-label.md)]

中间件只是一个位于适配器和机器人逻辑之间的类，它是在初始化期间添加到适配器的中间件集合的。 SDK 可让用户自行编写中间件或添加其他人创建的中间件的可重用组件。 可中间件中执行哪些操作？ 可执行任何操作...进出机器人的每个活动都流经中间件。

适配器处理传入的活动并通过机器人中间件管道将其定向到机器人的逻辑，然后再返回。 当每个活动流入和流出机器人时，每个中间件都可以在机器人逻辑运行前后对其进行检查或执行操作。

在深入了解中间件之前，请务必先了解[机器人概要](~/v4sdk/bot-builder-basics.md)和[机器人处理活动的方式](~/v4sdk/bot-builder-concept-activity-processing.md)。

## <a name="uses-for-middleware"></a>中间件用法

常见问题：与机器人逻辑相比，哪些操作通过中间件执行？ 中间件非常灵活，因此操作最终由用户决定。 下面介绍了中间件的几种很棒的用途。

### <a name="looking-at-or-acting-on-every-activity"></a>观察或操作每个活动

很多情况下，需要机器人对每个活动或某种类型的每个活动执行某些操作。 例如，我们可能希望记录机器人收到的每个消息活动，或者在机器人本回合未生成响应时提供回退响应。 中间件便是实现这种操作的绝佳位置，它能够在执行剩余机器人逻辑的前后执行操作。

### <a name="modifying-or-enhancing-the-turn-context"></a>修改或增强回合上下文

如果机器人知道的信息比活动中提供的多，这会让某些聊天将更富成效。 在这种情况下，中间件可以查看截至目前的聊天状态信息、查询外部数据源，还可在将执行传递给机器人逻辑之前将其附加到上下文对象。
例如，中间件可以识别聊天详细信息（例如聊天 ID 和状态），然后查询目录服务获取信息。 中间件可以将从该外部查询接收的用户对象添加到上下文对象并进行传递，从而提供有关用户的详细数据，让机器人能够更好地处理请求。

中间件可归入以上这两种用途，也可完全用于其他用途；这一切都取决于你希望如何构造机器人以及机器人尝试实现什么目标。
中间件可以建立或保留状态，对传入的请求作出反应，或让管道短路。
一些候选中间件包括：

- **存储或保留**：使用中间件存储或保留一个回合后的值，或基于该聊天发生的操作更新某些值。
- **错误处理或正常失败**：如果引发异常，中间件可针对该异常发送用户易查看的消息。
- **转换**：此中间件可以检测并转换传入的消息，并设置传出的消息，使其要转换回所检测到的传入语言。

你可自行定义中间件，或由 SDK 定义一些表示与应用程序无关的组件的中间件，例如：

- 状态中间件，它用于保留并还原上下文对象的状态信息。 SDK 提供聊天和用户状态中间件。
- 转换中间件，它可识别输入语言并转换成另一种语言，例如应用程序理解的语言。
- 日志中间件，它可记录传入和传出的活动。

## <a name="the-bot-middleware-pipeline"></a>机器人中间件管道

对于每个活动，适配器都按照其添加顺序调用中间件。 适配器传入回合的上下文对象和下一个委托，而中间件会调用该委托，将控制权传递给管道中的下一个中间件。 在完成方法之前，中间件仍有机会在下一个委托返回后执行操作。 你可以将其视为每个中间件对象始终都有机会对管道中的下一个中间件对象执行操作。

例如：

- 第一个中间件对象的回合处理程序在调用下一个对象之前执行代码。
  - 第二个中间件对象的回合处理程序在调用下一个对象之前执行代码。
    - 机器人的回合处理程序执行操作并返回结果。
  - 第二个中间件对象的回合处理程序在返回之前执行代码的所有余下部分。
- 第一个中间件对象的回合处理程序在返回之前执行代码的所有余下部分。

如果中间件不调用下一个委托，则适配器不会调用任何后续中间件或机器人回合处理程序，并且管道出现短路。

机器人中间件管道完成后，回合结束，且回合上下文超出范围。

中间件或机器人可以生成响应并注册响应事件处理程序，但请记住，响应是在单独的进程中处理的。

## <a name="order-of-middleware"></a>中间件的顺序

由于添加中间件的顺序决定了中间件处理活动的顺序，因此有必要确定添加中间件的顺序。

> [!NOTE]
> 这意味着为你提供一种适用于大多数机器人的通用模式，但一定要根据自己的情况考虑每个中间件将如何与其他中间件进行交互。

处理每次使用的最低级别任务的中间件应该排在中间件管道中的最前面。 相关示例包括日志记录、异常处理、状态管理和转换。 其排序顺序视需要而定，例如是要先转换传入的消息再处理任何异常，还是要先处理异常，后者可能意味着不会转换异常消息。

机器人特定的中间件应该排在中间件管道中的最后面，此类中间件可对发送到机器人的每个消息进行某些处理。 如果中间件使用状态信息或机器人上下文中设置的其他信息，请将其添加到中间件管道中用于修改状态或上下文的中间件的后面。

## <a name="short-circuiting"></a>短路

有关中间件（和[事件处理程序](~/v4sdk/bot-builder-concept-activity-processing.md#response-event-handlers)）的一个重要概念便是短路。 如果要通过后续的层继续执行，需使用中间件（或处理程序）调用该执行的下一个委托，将执行传递下去。  如果未在该中间件（或处理程序）中调用下一个委托，则当前管道将发生短路并且不会执行后续层。 这意味着将跳过所有机器人逻辑以及管道中后面的所有中间件。

对于事件处理程序，不调用下一个委托则会取消事件，这与中间件跳过逻辑得到的结果明显不同。 如果不处理事件的其余部分，则适配器永远不会发送该事件。

> [!TIP]
> 如果事件（如 `SendActivities`）短路，请确保这是意料中的行为。 否则，这可能导致令人非常混乱的 bug。

## <a name="next-steps"></a>后续步骤

你已熟悉了机器人的一些主要概念，接下来让我们深入了解机器人如何主动传递消息。

> [!div class="nextstepaction"]
> [主动传递消息](~/v4sdk/bot-builder-proactive-messages.md)
